# Ralph Progress Log

## Codebase Patterns
- This is a Next.js 16 web app, NOT React Native/Flutter mobile
- Uses Tailwind CSS v4 for styling
- App router in src/app/ directory
- Components go in src/app/components/
- Utilities/lib files go in src/app/lib/
- Use "use client" directive for client components using hooks like usePathname
- For Playwright tests, do NOT use `networkidle` wait - Next.js HMR keeps connections open
- Use `data-testid` attributes for test selectors
- For GPS location on web, use navigator.geolocation API (not React Native location APIs)
- For reverse geocoding, use Nominatim OpenStreetMap API (free, no API key needed)
- Database modules in src/app/lib/: moments.ts, entities.ts, sessions.ts, profile.ts
- Use db.ts as unified export for all database types and functions
- migrations.ts handles schema versioning with incremental migrations

## Learnings

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019bad2a-e26b-71eb-b27d-f6c0dd4b9379
- Implemented project setup and navigation shell for DogTracer web app
- Files changed:
  - src/app/layout.tsx (updated metadata, added BottomNav)
  - src/app/page.tsx (new home page)
  - src/app/components/BottomNav.tsx (new bottom navigation component)
  - src/app/timeline/page.tsx (placeholder)
  - src/app/encounters/page.tsx (placeholder)
  - src/app/profile/page.tsx (placeholder)
- **Learnings for future iterations:**
  - Despite PRD saying React Native/Flutter, the actual project is Next.js web - ignore mobile-native requirements
  - Bottom navigation uses fixed positioning with pb-16 on main content to prevent overlap
  - Active tab uses amber-600 color scheme
  - Using Heroicons-style SVG icons for navigation
  - Browser test at scripts/ralph/smoke.spec.ts checks homepage loads with title
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019bad34-5020-7315-8474-cdaf405a7d82
- Implemented GPS location capture for moments with reverse geocoding
- Files changed:
  - src/app/lib/moments.ts (added GpsLocation interface, updated Moment interface and createMoment function)
  - src/app/lib/location.ts (new file - geolocation and reverse geocoding utilities)
  - src/app/components/CameraButton.tsx (integrated location capture, added loading state, shows place label in confirmation)
- **Learnings for future iterations:**
  - Use navigator.geolocation.getCurrentPosition() for web browser location
  - Nominatim OpenStreetMap reverse geocoding is free and doesn't need API key
  - GpsLocation stores: latitude, longitude, accuracy (meters), placeLabel (nullable)
  - Location is captured in parallel with photo reading for better performance
  - Handle location gracefully when unavailable (gps field is null)
  - Button shows loading spinner while capturing location
  - Confirmation message includes place label when available
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019bad2f-a139-744a-b3d8-6ee6bce5dc96
- Implemented moment capture with photo and timestamp
- Files changed:
  - src/app/page.tsx (added CameraButton component)
  - src/app/components/CameraButton.tsx (new camera capture component with confirmation feedback)
  - src/app/lib/moments.ts (new local storage utility for moments)
  - scripts/ralph/smoke.spec.ts (added camera button visibility test, fixed networkidle issue)
- **Learnings for future iterations:**
  - Use `capture="environment"` attribute on file input for mobile camera access
  - For photo capture on web, use file input with `accept="image/*"` - works on both desktop and mobile
  - Store photos as base64 data URLs in localStorage for simplicity (IndexedDB for larger apps)
  - Moment interface: id, photoDataUrl, timestamp (ISO), timestampLocal, createdAt
  - Playwright tests fail with `networkidle` on Next.js dev server due to HMR - use default `load` wait
  - Added `data-testid="camera-button"` for test selectors
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019bad37-068b-74d8-b8e2-1448ebcfbba3
- Implemented quick tags and notes for moment capture
- Files changed:
  - src/app/lib/moments.ts (added MomentTag type, MOMENT_TAGS constant, tags/notes fields to Moment interface)
  - src/app/components/TagsModal.tsx (new modal component with tag selection and notes input)
  - src/app/components/CameraButton.tsx (integrated TagsModal, show modal after photo capture before saving)
  - scripts/ralph/smoke.spec.ts (added test for tags modal UI elements)
- **Learnings for future iterations:**
  - Modal appears after photo capture, before moment is saved to localStorage
  - Tags are toggleable buttons with emoji icons for visual feedback
  - Selected tags use amber-500 background, unselected use gray-100
  - Notes field is optional textarea below tags
  - Cancel button discards the pending capture
  - Save button commits moment with selected tags and notes
  - All 9 preset tags implemented: walk, play, rest, training, feeding, vet, bath, social, stress
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019bad39-d9da-72eb-ab4a-c80a22349463
- Implemented robust local database schema for moments, entities, sessions, and profiles
- Files changed:
  - src/app/lib/moments.ts (added mood, moodConfidence, entityIds, sessionId fields; added MomentMood type)
  - src/app/lib/entities.ts (new - Entity/DogEntity/HumanEntity interfaces with metadata, CRUD functions)
  - src/app/lib/sessions.ts (new - Session interface with moment clustering, type, behavior flags)
  - src/app/lib/profile.ts (new - DogProfile interface with temperament, triggers, goals)
  - src/app/lib/migrations.ts (new - schema versioning with runMigrations function)
  - src/app/lib/db.ts (new - unified export for all database modules)
- **Learnings for future iterations:**
  - Moments table extended with: mood (MomentMood | null), moodConfidence (0-100), entityIds[], sessionId
  - Entities table has polymorphic type (dog/human) with type-specific metadata interfaces
  - DogEntity metadata: breed, sex, size, relationship (friend/neutral/conflict/unknown), isPrimary
  - HumanEntity metadata: relationship (owner/friend/stranger/neighbor/vet/trainer)
  - Sessions table: id, type, startTime, endTime, momentIds, keyPhotoIds, behaviorFlags, placeLabel
  - DogProfile: name, age, temperament[] (10 options), triggers[], goals[]
  - Migration system uses version numbers; each migration has name and migrate() function
  - Use generateEntityId()/generateSessionId()/generateProfileId() for consistent ID generation
  - Import from db.ts for unified access to all database types and functions
---

## 2026-01-11 - US-006
Thread: https://ampcode.com/threads/T-019bad3d-1b5a-7148-86c8-fdc6136b0792
- Implemented cloud entity detection API integration with mock backend
- Files changed:
  - src/app/lib/detection.ts (new - detection types, queue, API service, retry logic)
  - src/app/api/detect/route.ts (new - mock detection API endpoint)
  - src/app/lib/db.ts (added detection exports)
  - src/app/lib/moments.ts (added updateMoment function)
  - src/app/components/CameraButton.tsx (integrated detection after moment save)
- **Learnings for future iterations:**
  - Mock API endpoint at /api/detect returns random dog/human detections
  - Detection runs asynchronously after moment is saved (non-blocking UX)
  - DetectionResult stores: entities[], status, retryCount, error
  - Offline queue with retry logic: MAX_RETRIES=3, RETRY_DELAY_MS=5000
  - BoundingBox uses normalized coords (0-1) for x, y, width, height
  - processDetection() handles full flow: call API, save result, manage queue
  - getPendingDetectionCount() returns number of queued items for UI sync indicator
  - Import from detection.ts or db.ts for detection types and functions
---

## 2026-01-11 - US-007
Thread: https://ampcode.com/threads/T-019bad40-18e1-714d-a600-6e63af1ea005
- Implemented dog labeling for detected entities with visual indicators on photos
- Files changed:
  - src/app/lib/labeling.ts (new - dog label utilities with displayLabel resolution)
  - src/app/components/DetectionOverlay.tsx (new - visual bounding box overlay for detected dogs)
  - src/app/components/MomentCard.tsx (new - moment display card with detection overlay)
  - src/app/lib/db.ts (added labeling module export)
  - scripts/ralph/smoke.spec.ts (added detection overlay test)
- **Learnings for future iterations:**
  - Primary dog uses [PRIMARY_DOG] label, shows amber color (#f59e0b) with ‚≠ê star indicator
  - Other dogs use [OTHER_DOG_1], [OTHER_DOG_2] labels with blue color (#3b82f6)
  - getDogDisplayLabel() resolves labels to profile name or entity name if available
  - DetectionOverlay uses CSS percentage-based positioning from normalized bounding box coords
  - MomentCard fetches detection results and renders DetectionOverlay on top of photo
  - LabeledEntity extends DetectedEntity with displayLabel and optional entityId
  - Use data-testid="primary-dog-indicator" and "other-dog-indicator" for test selectors
---

## 2026-01-11 - US-008
Thread: https://ampcode.com/threads/T-019bad42-ca40-72da-b99c-0119bb106a06
- Implemented human labeling for detected entities with visual indicators on photos
- Files changed:
  - src/app/lib/labeling.ts (added getHumanDisplayLabel, getHumanLabelColor, isHumanLabel functions)
  - src/app/components/DetectionOverlay.tsx (updated to render human detection boxes with green color and üë§ indicator)
  - scripts/ralph/smoke.spec.ts (added test for person-indicator)
- **Learnings for future iterations:**
  - Humans use [PERSON_1], [PERSON_2] labels with green color (#10b981)
  - getHumanDisplayLabel() resolves [PERSON_N] to named entity if available
  - Privacy preserved: no automatic face recognition or identity guessing
  - Human indicators use data-testid="person-indicator" for test selectors
  - labelDetectedEntities() now handles both dog and human types
---

## 2026-01-11 - US-009
Thread: https://ampcode.com/threads/T-019bad45-f237-70ed-bfd6-6cbe787153c9
- Implemented identity management with entity naming dialog for detected dogs and people
- Files changed:
  - src/app/components/EntityNamingModal.tsx (new - modal for naming entities with all metadata fields)
  - src/app/components/DetectionOverlay.tsx (added onEntityTap callback prop for clickable entities)
  - src/app/components/MomentCard.tsx (integrated entity tap handling and naming modal)
  - scripts/ralph/smoke.spec.ts (added test for entity naming modal fields)
- **Learnings for future iterations:**
  - EntityNamingModal is reusable for both dogs and humans with type-specific fields
  - Dogs: name, breed (optional), sex, size, relationship (friend/neutral/conflict/unknown)
  - Humans: name, relationship (owner/friend/stranger/neighbor/vet/trainer)
  - Notes field available for interaction details on both entity types
  - Detection boxes become clickable when onEntityTap prop is provided
  - Modal loads existing entity data if entityId is provided (edit mode)
  - Use forceUpdate pattern to refresh labels after entity save
  - Test data-testid patterns: entity-name-input, entity-notes-input, entity-modal-save, entity-modal-cancel
---
